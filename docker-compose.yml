version: "3.8"
name: servarr
services:
  # User apps
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    environment:
      - device=/dev/dri:/dev/dri
      - PUID=13001
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
      - VERSION=docker
    volumes: 
      - /home/nathan/servarr/config/plex-config:/config
      - /mnt/data/media:/data/media
    ports:
      - 32400:32400
    restart: unless-stopped
  
  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=13002
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/config/overseerr-config:/config
    ports:
      - 5055:5055
    restart: unless-stopped

  # Media management
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: service:gluetun
    environment:
      - PUID=13003
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/scripts/sonarr/custom-services:/custom-services.d
      - /home/nathan/servarr/scripts/sonarr/custom-cont-init:/custom-cont-init.d
      - /home/nathan/servarr/config/sonarr-config:/config
      - /mnt/data:/data
    restart: unless-stopped

  4ksonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: 4ksonarr
    network_mode: service:gluetun
    environment:
      - PUID=13003
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/scripts/sonarr/custom-services:/custom-services.d
      - /home/nathan/servarr/scripts/sonarr/custom-cont-init:/custom-cont-init.d
      - /home/nathan/servarr/config/4ksonarr-config:/config
      - /mnt/data:/data
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: service:gluetun
    environment:
      - PUID=13004
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/scripts/radarr/custom-services:/custom-services.d
      - /home/nathan/servarr/scripts/radarr/custom-cont-init:/custom-cont-init.d
      - /home/nathan/servarr/config/radarr-config:/config
      - /mnt/data:/data
    restart: unless-stopped

  4kradarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: service:gluetun
    environment:
      - PUID=13004
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/scripts/radarr/custom-services:/custom-services.d
      - /home/nathan/servarr/scripts/radarr/custom-cont-init:/custom-cont-init.d
      - /home/nathan/servarr/config/4kradarr-config:/config
      - /mnt/data:/data
    restart: unless-stopped

  bazarr: 
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    network_mode: service:gluetun
    environment:
      - PUID=13005
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/config/bazarr-config:/config
      - /mnt/data/media:/data/media
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: service:gluetun
    environment:
      - PUID=13006
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/config/prowlarr-config:/config
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: service:gluetun
    environment:
      - PUID=13007
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
      - WEBUI_PORT=8080
    volumes:
      - /home/nathan/servarr/config/qbittorrent-config:/config
      - /mnt/data/torrents:/data/torrents
    restart: unless-stopped

  maintainerr:
    image: ghcr.io/jorenn92/maintainerr:latest 
    container_name: maintainerr
    user: 13008:13000
    volumes:
      - /home/nathan/servarr/config/maintainerr-config:/opt/data
    environment:
      - TZ=Canada/Pacific
    ports:
      - 6246:6246
    restart: unless-stopped

  # User management
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    depends_on:
      - plex
    environment:
      - PUID=13009
      - PGID=13000
      - UMASK=002
      - TZ=Canada/Pacific
    volumes:
      - /home/nathan/servarr/config/tautulli-config:/config
    ports:
      - 8181:8181
    restart: unless-stopped

  wizarr:
    image: ghcr.io/wizarrrr/wizarr:latest
    container_name: wizarr
    volumes:
      - /home/nathan/servarr/config/wizarr-config:/data/database
    ports:
      - 5690:5690
    restart: unless-stopped

  # Networking
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    restart: unless-stopped

  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${MULLVAD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=10.70.151.218/32
      - SERVER_CITIES=Seattle WA
      - TZ=Canada/Pacific
    ports:
      - 8191:8191 # flaresolverr
      - 8989:8989 # sonarr
      - 8988:8989 # 4ksonarr
      - 7878:7878 # radarr
      - 7877:7878 # 4kradarr
      - 6767:6767 # bazarr
      - 9696:9696 # prowlarr
      - 8080:8080 # qbittorrent
      - 6881:6881 # qbittorrent
      - 6881:6881/udp # qbittorrent
    restart: unless-stopped

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    network_mode: service:gluetun
    environment:
      - TZ=Canada/Pacific
    restart: unless-stopped

  # Container updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    command: --cleanup true --remove-volumes true --schedule "30 9 * * *" --rolling-restart true
    restart: unless-stopped
